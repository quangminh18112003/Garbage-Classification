"""
Workflow ƒë·ªÉ commit training results l√™n GitHub
"""
import os
import subprocess
from datetime import datetime
from pathlib import Path

def run_command(cmd):
    """Execute command and return output"""
    result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
    return result.stdout, result.stderr, result.returncode

def commit_training_results():
    """Commit training k·∫øt qu·∫£"""
    repo_path = Path(__file__).parent.parent
    os.chdir(repo_path)
    
    # Check if training results exist
    runs_path = repo_path / "training" / "runs_train"
    if not runs_path.exists():
        print("‚ùå Training results not found")
        return False
    
    # Get latest experiment folder
    exp_folders = sorted([d for d in runs_path.glob("exp*")], key=lambda x: x.stat().st_mtime, reverse=True)
    if not exp_folders:
        print("‚ùå No experiment folder found")
        return False
    
    latest_exp = exp_folders[0]
    print(f"‚úÖ Found latest experiment: {latest_exp.name}")
    
    # Create training summary
    summary_file = repo_path / "TRAINING_RESULTS.md"
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    results_content = f"""# üéØ Training Results - {timestamp}

## Experiment Info
- **Name**: {latest_exp.name}
- **Date**: {timestamp}
- **Path**: {latest_exp}

## Results
- Weights saved at: `{latest_exp}/weights/best.pt`
- Training plots: See `{latest_exp}` directory

### Key Metrics
Check the following files in experiment folder:
- `results.csv` - Detailed training metrics
- `confusion_matrix.png` - Confusion matrix visualization
- `P_curve.png` - Precision curve
- `R_curve.png` - Recall curve
- `F1_curve.png` - F1 score curve
- `PR_curve.png` - Precision-Recall curve

## Next Steps
1. Copy weights to GiaoDien/weights/ if best model
2. Test with Streamlit app
3. Evaluate on test set

---
Generated by training workflow
"""
    
    with open(summary_file, 'w', encoding='utf-8') as f:
        f.write(results_content)
    
    print(f"‚úÖ Created training results summary")
    
    # Commit results
    stdout, stderr, code = run_command("git add TRAINING_RESULTS.md")
    if code != 0:
        print(f"‚ö†Ô∏è Git add warning: {stderr}")
    
    stdout, stderr, code = run_command(f'git commit -m "Add training results from {latest_exp.name}"')
    if code == 0:
        print("‚úÖ Successfully committed training results")
        return True
    else:
        print(f"‚ö†Ô∏è Commit message: {stdout}")
        return False

if __name__ == "__main__":
    commit_training_results()
